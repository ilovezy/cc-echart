<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>主要财务指标</title>
    <link rel="stylesheet" href="bootstrap-3.2.0-dist/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="css/cc-echarts.css">
    <link rel="stylesheet" type="text/css" href="DataTables-1.10.10/media/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="DataTables-1.10.10/extensions/RowReorder/css/rowReorder.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="../toolkitcss/v5/commonM/style.css">
</head>

<body class="container-fluid">
    <h1 class="text-center">自选股的新浪数据
    <button type="" class="btn btn-success" id="getDataBtn">getData</button>
    </h1>

    <table id="multipleCompanyInfo" class="table table-hover table-striped text-center table-bordered table-responsive">
        <thead>
            <tr>
                <th class="text-center">代码</th>
                <th class="text-center">简称</th>
                <th class="text-center">当前价格</th>
                <th class="text-center">涨跌量</th>
                <th class="text-center">涨跌幅</th>
                <th class="text-center">持仓数量</th>
                <th class="text-center">持仓单价</th>
                <th class="text-center">市值</th>
                <th class="text-center">今日涨跌</th>
                <th class="text-center">累计盈亏</th>
                <th class="text-center">累计盈亏率</th>
            </tr>
        </thead>
        <tbody>

        </tbody>
    </table>


    <script src="js/jquery-1.11.1.min.js"></script>
    <script src="bootstrap-3.2.0-dist/js/bootstrap.min.js"></script>
    <script src="DataTables-1.10.10/media/js/jquery.dataTables.min.js"></script>
    <script src="DataTables-1.10.10/extensions/RowReorder/js/dataTables.rowReorder.min.js"></script>
    <script src="js/URI.min.js"></script>


    <!-- 正常的方法 -->
    <!-- // <script id="sinaData " type="text/javascript " src="http://hq.sinajs.cn/list=sz000002 " charset="gb2312 "></script> -->

    <!-- 多个公司 -->
    <!-- // <script src="http://hq.sinajs.cn/list=s_sz000001,s_sz000002,s_sz000003,s_sz000004,s_sz000005"></script> -->

    <script type="text/javascript">
    $('#getDataBtn').click(function() {
        $.ajax({
            // 这是后台取来的json数据格式
            url: '../list/accounting_optionalunit.c?_toolkit=json',
            type: 'GET',
            dataType: 'JSON'

        }).done(function(data) {
            // console.log(data.AR_OPTIONAL_UNIT);
            var AR_OPTIONAL_UNIT = data.AR_OPTIONAL_UNIT;
            var MultipleTcodeArr = [];

            $.each(AR_OPTIONAL_UNIT, function(index, val) {
                MultipleTcodeArr.push(val.Tcode);
            });

            $.each(MultipleTcodeArr, function(index, val) {
                if (val.charAt(0) == '6') {
                    MultipleTcodeArr[index] = 's_sh' + val;
                } else {
                    MultipleTcodeArr[index] = 's_sz' + val;
                }
            });

            var searchString = MultipleTcodeArr.join(',');

            // 去新浪获取一堆股票数据 （上证综合指数）
            var multipleDataUrl = 'http://hq.sinajs.cn/list=' + searchString;
            $.ajax({
                cache: true, // 这里必须为 true 不能为false
                url: multipleDataUrl,
                type: "GET",
                async: false,
                dataType: "script"
            }).done(function() {

                var MultiplecompanyInfoArr = [];
                var tempArr = [];

                // 这是新浪的数据
                $.each(MultipleTcodeArr, function(index, val) {
                    if (window['hq_str_' + val]) {
                        tempArr = window['hq_str_' + val].split(',');
                    } else {
                        tempArr = [];
                    }

                    tempArr.unshift(val);

                    // 这里加入一堆后台数据

                    var ArItem = AR_OPTIONAL_UNIT[index];
                    var PositionNum = +ArItem.PositionNum || '--';
                    var PositionPrice = +ArItem.PositionPrice || '--';
                    var PositionTotal = +ArItem.PositionTotal || '--';

                    tempArr.push(PositionNum || '--'); // 持仓数量
                    tempArr.push(PositionPrice || '--'); // 持仓单价
                    tempArr.push(PositionTotal || '--'); // 市值

                    // 今日涨跌(涨跌率*持仓数量)
                    var todayRate = (+tempArr[3]) * PositionNum;
                    if ($.isNumeric(todayRate)) {
                        tempArr.push(todayRate.toFixed(3));
                    } else {
                        tempArr.push('--');
                    }

                    // 累计盈亏（现在市值 - 成本（持仓单价 * 持仓数量））
                    var countEarn = PositionTotal - (PositionPrice * PositionNum);
                    if ($.isNumeric(countEarn)) {
                        tempArr.push(countEarn.toFixed(3));
                    } else {
                        tempArr.push('--');
                    }

                    var countEarnRate = (PositionTotal - PositionPrice * PositionNum) / (PositionPrice * PositionNum);
                    if ($.isNumeric(countEarnRate)) {
                        tempArr.push(countEarnRate.toFixed(3));
                    } else {
                        tempArr.push('--');
                    }

                    MultiplecompanyInfoArr.push(tempArr);
                });

                var trStr = '';
                $.each(MultiplecompanyInfoArr, function(index, val) {

                    console.log(val + ' ' + val.length);

                    trStr += '<tr><td>' + (val[0].substring(4) || '--') + '</td><td><a href="#">' + (val[1] || '--') + '</a></td><td>' + (val[2] || '--') + '</td><td>' + (val[3] || '--') + '</td>';

                    if (val[4]) {
                        if (val[4] > 0) {
                            trStr += '<td style="color: red">' + val[4] + '%</td>';
                        } else if (val[4] < 0) {
                            trStr += '<td style="color: green">' + val[4] + '%</td>';
                        } else {
                            trStr += '<td>' + val[4] + '%</td>';
                        }
                    } else {
                        trStr += '<td>--</td>';
                    }

                    trStr += '<td>' + val[7] + '</td><td>' + val[8] + '</td><td>' + val[9] + '</td><td>' + val[10] + '</td><td>' + val[11] + '</td><td>' + val[12] + '</td>' + '</tr>';
                });

                $('#multipleCompanyInfo tbody').empty().append(trStr);

                $.each(MultipleTcodeArr, function(index, val) {
                    MultipleTcodeArr[index] = val.substring(4);
                });

                // 调用 DataTable 这里 rowReorder 只有 1.10.8 以上才支持
                // 我之前用的正好是 1.10.7 ...
                $("#multipleCompanyInfo").dataTable({
                    info: false,
                    paging: false,
                    searching: false,
                    rowReorder: true
                });
            });
        });

    });

    // var MultipleTcodeArr = ['000001', '000002', '000003', '000004', '000005', '000009', '000011'];
    // getMultipleCompanyInfo(MultipleTcodeArr);
    // 新浪数据 6秒刷一次
    // setInterval("getMultipleCompanyInfo(MultipleTcodeArr)", 6000);
    </script>
</body>

</html>
